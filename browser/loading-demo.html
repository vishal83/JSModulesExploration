<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>⚡ Module Loading Demo</title>
    <link rel="stylesheet" href="/browser/css/design-system.css">
    <style>
        /* Additional styles for loading demo specific features */
        .demo-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-xl);
            margin-bottom: var(--space-3xl);
        }
        
        @media (max-width: 768px) {
            .demo-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .timeline {
            background: var(--bg-glass-dark);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: var(--radius-lg);
            padding: var(--space-lg);
            margin: var(--space-lg) 0;
            font-family: var(--font-mono);
            font-size: var(--text-sm);
            line-height: 1.5;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            color: var(--text-inverse);
        }
        
        .timeline.browser {
            border-left: 4px solid var(--accent-green);
        }
        
        .timeline.nodejs {
            border-left: 4px solid var(--accent-orange);
        }
        
        .comparison-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-lg);
            margin-top: var(--space-lg);
        }
        
        @media (max-width: 768px) {
            .comparison-grid {
                grid-template-columns: 1fr;
            }
        }
        
        .comparison-item {
            background: var(--bg-glass);
            padding: var(--space-lg);
            border-radius: var(--radius-lg);
            border-left: 4px solid;
        }
        
        .comparison-item.browser {
            border-left-color: var(--accent-green);
        }
        
        .comparison-item.nodejs {
            border-left-color: var(--accent-orange);
        }
        
        .comparison-item h4 {
            margin-bottom: var(--space-md);
            color: var(--text-inverse);
            font-weight: 600;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚡ Module Loading Behavior Demo</h1>
            <p>Compare how modules load in browsers vs Node.js - see the difference in real-time!</p>
        </div>
        
        <nav class="nav">
            <a href="/" class="nav-link">🏠 Home</a>
            <a href="/esm-demo" class="nav-link">📦 ES Modules</a>
            <a href="/dynamic-demo" class="nav-link">🔄 Dynamic Imports</a>
            <a href="https://github.com/vishal83/JSModulesExploration" target="_blank" class="nav-link">📚 GitHub</a>
        </nav>
        
        <div class="demo-grid">
            <div class="demo-section">
                <h2>
                    🌐 Browser Loading (ES Modules)
                    <span id="browser-status" class="status loading">
                        <div class="loading-spinner"></div>
                        Loading
                    </span>
                </h2>
                
                <div class="info-box">
                    <h3>How Browser Loading Works:</h3>
                    <ul>
                        <li>📋 Parse HTML and find &lt;script type="module"&gt;</li>
                        <li>🔍 Parse JavaScript, find import statements</li>
                        <li>⚡ Fetch all modules in parallel (hoisted)</li>
                        <li>⏳ Wait for all imports to resolve</li>
                        <li>🚀 Execute script code</li>
                    </ul>
                </div>
                
                <button onclick="simulateBrowserLoading()" class="btn btn-success">Simulate Loading</button>
                <button onclick="clearBrowserLog()" class="btn btn-secondary">Clear Log</button>
                
                <div id="browser-timeline" class="timeline browser">
🌐 Browser ES Module Loading Timeline:

Waiting for simulation...
                </div>
            </div>
            
            <div class="demo-section">
                <h2>🟢 Node.js Comparison</h2>
                
                <div class="info-box">
                    <h3>How Node.js Loading Works:</h3>
                    <ul>
                        <li>📝 Execute code line by line</li>
                        <li>🔄 Hit require() → pause execution</li>
                        <li>📥 Load module synchronously</li>
                        <li>✅ Continue execution</li>
                        <li>🏁 Complete</li>
                    </ul>
                </div>
                
                <button onclick="simulateNodeJSLoading()" class="btn btn-success">Simulate Node.js</button>
                <button onclick="clearNodeLog()" class="btn btn-secondary">Clear Log</button>
                
                <div id="nodejs-timeline" class="timeline nodejs">
🟢 Node.js CommonJS Loading Timeline:

Waiting for simulation...
                </div>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>📊 Side-by-Side Comparison</h2>
            
            <button onclick="runComparison()" class="btn btn-primary">Run Side-by-Side Comparison</button>
            <button onclick="clearComparison()" class="btn btn-secondary">Clear</button>
            
            <div class="comparison-grid">
                <div class="comparison-item browser">
                    <h4>🌐 Browser (ES Modules)</h4>
                    <div id="browser-comparison" class="timeline">
Click "Run Comparison" to see both loading patterns simultaneously!
                    </div>
                </div>
                
                <div class="comparison-item nodejs">
                    <h4>🟢 Node.js (CommonJS)</h4>
                    <div id="nodejs-comparison" class="timeline">
Click "Run Comparison" to see both loading patterns simultaneously!
                    </div>
                </div>
            </div>
        </div>
        
        <div class="demo-section">
            <h2>🔍 Real Module Loading Analysis</h2>
            <p>This page itself demonstrates ES module loading! Check your browser's Developer Tools:</p>
            
            <div class="info-box">
                <h3>🛠️ Developer Tools Analysis:</h3>
                <ol>
                    <li><strong>Network Tab:</strong> See how modules are fetched</li>
                    <li><strong>Console:</strong> View loading order and timing</li>
                    <li><strong>Sources Tab:</strong> Examine module dependencies</li>
                    <li><strong>Performance Tab:</strong> Analyze loading performance</li>
                </ol>
            </div>
            
            <button onclick="analyzeCurrentPage()" class="btn btn-primary">Analyze This Page</button>
            <button onclick="showNetworkTips()" class="btn btn-secondary">Network Tips</button>
            
            <div id="analysis-output" class="timeline">
Click "Analyze This Page" to examine how this very page loaded its modules!
            </div>
        </div>
    </div>

    <script type="module">
        // This script demonstrates real ES module loading in the browser!
        console.time('Total ES Module Loading');
        console.log('🌐 [Browser] Starting ES module loading...');
        
        // These imports are hoisted and loaded in parallel
        import { add, multiply, Calculator } from '/esm/math-utils.js';
        import { config, isProduction } from '/esm/config.js';
        
        console.log('🌐 [Browser] All imports resolved, executing script...');
        console.timeEnd('Total ES Module Loading');
        
        // Update status
        document.getElementById('browser-status').innerHTML = `
            <span class="status success">
                ✅ Loaded
            </span>
        `;
        
        // Simulation functions
        window.simulateBrowserLoading = function() {
            const timeline = document.getElementById('browser-timeline');
            timeline.innerHTML = '🌐 Browser ES Module Loading Timeline:\n\n';
            
            let step = 0;
            const steps = [
                '⏰ 0ms    - HTML parsing begins',
                '⏰ 2ms    - Found <script type="module">',
                '⏰ 3ms    - Parsing JavaScript, finding imports...',
                '⏰ 5ms    - 🔍 Found import statements (hoisted!)',
                '⏰ 6ms    - 📡 Fetching /esm/math-utils.js',
                '⏰ 7ms    - 📡 Fetching /esm/config.js', 
                '⏰ 8ms    - 📡 Fetching /esm/user-service.js',
                '⏰ 12ms   - ⚡ All modules fetching in parallel...',
                '⏰ 45ms   - ✅ math-utils.js loaded',
                '⏰ 52ms   - ✅ config.js loaded',
                '⏰ 58ms   - ✅ user-service.js loaded',
                '⏰ 60ms   - 🔗 Resolving module dependencies...',
                '⏰ 62ms   - 🚀 All imports resolved, executing script!',
                '⏰ 65ms   - 📝 console.log("Script execution starts")',
                '⏰ 68ms   - 🧮 Using imported add(5, 10) = 15',
                '⏰ 70ms   - ✅ Script execution complete!',
                '',
                '🔑 Key Points:',
                '• All imports are hoisted (processed first)',
                '• Modules load in parallel, not sequentially', 
                '• Script execution waits for ALL imports',
                '• No blocking during loading phase'
            ];
            
            const interval = setInterval(() => {
                if (step < steps.length) {
                    timeline.innerHTML += steps[step] + '\n';
                    timeline.scrollTop = timeline.scrollHeight;
                    step++;
                } else {
                    clearInterval(interval);
                }
            }, 300);
        };
        
        window.simulateNodeJSLoading = function() {
            const timeline = document.getElementById('nodejs-timeline');
            timeline.innerHTML = '🟢 Node.js CommonJS Loading Timeline:\n\n';
            
            let step = 0;
            const steps = [
                '⏰ 0ms    - Node.js script execution begins',
                '⏰ 1ms    - 📝 console.log("Script started")',
                '⏰ 2ms    - 🔍 Encountered require("./math-utils")',
                '⏰ 3ms    - ⏸️  EXECUTION PAUSED (blocking)',
                '⏰ 4ms    - 📥 Loading math-utils.js...',
                '⏰ 25ms   - 🔄 Executing math-utils.js code...',
                '⏰ 30ms   - ✅ math-utils.js loaded and cached',
                '⏰ 31ms   - ▶️  EXECUTION RESUMED',
                '⏰ 32ms   - 📝 console.log("Math module loaded")',
                '⏰ 33ms   - 🔍 Encountered require("./config")',
                '⏰ 34ms   - ⏸️  EXECUTION PAUSED again',
                '⏰ 35ms   - 📥 Loading config.js...',
                '⏰ 55ms   - 🔄 Executing config.js code...',
                '⏰ 58ms   - ✅ config.js loaded and cached',
                '⏰ 59ms   - ▶️  EXECUTION RESUMED',
                '⏰ 60ms   - 🧮 Using add(5, 10) = 15',
                '⏰ 61ms   - ✅ Script execution complete!',
                '',
                '🔑 Key Points:',
                '• Synchronous, blocking execution',
                '• Modules load one at a time (sequential)',
                '• Each require() pauses execution',
                '• Code runs line by line'
            ];
            
            const interval = setInterval(() => {
                if (step < steps.length) {
                    timeline.innerHTML += steps[step] + '\n';
                    timeline.scrollTop = timeline.scrollHeight;
                    step++;
                } else {
                    clearInterval(interval);
                }
            }, 300);
        };
        
        window.runComparison = function() {
            const browserComp = document.getElementById('browser-comparison');
            const nodejsComp = document.getElementById('nodejs-comparison');
            
            browserComp.innerHTML = '🌐 Browser:\n⏰ Starting...\n';
            nodejsComp.innerHTML = '🟢 Node.js:\n⏰ Starting...\n';
            
            // Browser simulation
            const browserSteps = [
                '⏰ 0ms - Parse & hoist imports',
                '⏰ 5ms - Fetch modules in parallel',
                '⏰ 50ms - All modules loaded',
                '⏰ 52ms - Execute script',
                '✅ Complete (non-blocking)'
            ];
            
            // Node.js simulation
            const nodejsSteps = [
                '⏰ 0ms - Start execution',
                '⏰ 2ms - Hit require() - BLOCK',
                '⏰ 30ms - Module loaded - RESUME',
                '⏰ 32ms - Hit require() - BLOCK',
                '⏰ 60ms - Module loaded - RESUME',
                '✅ Complete (blocking)'
            ];
            
            let step = 0;
            const interval = setInterval(() => {
                if (step < Math.max(browserSteps.length, nodejsSteps.length)) {
                    if (step < browserSteps.length) {
                        browserComp.innerHTML += browserSteps[step] + '\n';
                    }
                    if (step < nodejsSteps.length) {
                        nodejsComp.innerHTML += nodejsSteps[step] + '\n';
                    }
                    step++;
                } else {
                    clearInterval(interval);
                }
            }, 800);
        };
        
        window.analyzeCurrentPage = function() {
            const output = document.getElementById('analysis-output');
            const perfEntries = performance.getEntriesByType('navigation');
            const resourceEntries = performance.getEntriesByType('resource');
            
            let analysis = `🔍 Real Page Loading Analysis:\n\n`;
            
            // Navigation timing
            if (perfEntries.length > 0) {
                const nav = perfEntries[0];
                analysis += `📊 Navigation Timing:\n`;
                analysis += `  • DNS Lookup: ${(nav.domainLookupEnd - nav.domainLookupStart).toFixed(2)}ms\n`;
                analysis += `  • TCP Connect: ${(nav.connectEnd - nav.connectStart).toFixed(2)}ms\n`;
                analysis += `  • Request: ${(nav.responseStart - nav.requestStart).toFixed(2)}ms\n`;
                analysis += `  • Response: ${(nav.responseEnd - nav.responseStart).toFixed(2)}ms\n`;
                analysis += `  • DOM Content Loaded: ${(nav.domContentLoadedEventEnd - nav.navigationStart).toFixed(2)}ms\n`;
                analysis += `  • Page Load Complete: ${(nav.loadEventEnd - nav.navigationStart).toFixed(2)}ms\n\n`;
            }
            
            // Resource timing (modules)
            const moduleResources = resourceEntries.filter(r => r.name.includes('.js') || r.name.includes('.mjs'));
            if (moduleResources.length > 0) {
                analysis += `📦 Module Loading:\n`;
                moduleResources.forEach(resource => {
                    const filename = resource.name.split('/').pop();
                    analysis += `  • ${filename}: ${resource.duration.toFixed(2)}ms\n`;
                });
                analysis += `\n`;
            }
            
            // Import meta info
            analysis += `🌐 Module Information:\n`;
            analysis += `  • Current module URL: ${import.meta.url}\n`;
            analysis += `  • Module type: ES Module (native browser support)\n`;
            analysis += `  • Import hoisting: ✅ Active\n`;
            analysis += `  • Parallel loading: ✅ Active\n\n`;
            
            // Browser capabilities
            analysis += `🚀 Browser Capabilities:\n`;
            
            // Check ES Modules support
            const hasESModules = 'noModule' in HTMLScriptElement.prototype;
            analysis += `  • ES Modules: ${hasESModules ? '✅' : '❌'}\n`;
            
            // Check dynamic import support
            const hasDynamicImport = true; // We're using it successfully here
            analysis += `  • Dynamic import(): ${hasDynamicImport ? '✅' : '❌'}\n`;
            
            analysis += `  • Top-level await: ✅ (in modules)\n`;
            
            // Check HTTP/2
            const isHTTPS = window.location.protocol === 'https:';
            analysis += `  • HTTP/2: ${isHTTPS ? '✅ Likely' : '❓ Unknown'}\n`;
            
            output.innerHTML = analysis;
            output.scrollTop = 0;
        };
        
        window.showNetworkTips = function() {
            const output = document.getElementById('analysis-output');
            output.innerHTML = `🛠️ Browser Developer Tools Tips:

📊 Network Tab Analysis:
  1. Open Dev Tools (F12) → Network Tab
  2. Reload page and watch module loading
  3. Look for:
     • Parallel requests for .js/.mjs files
     • "type: module" in request headers
     • CORS headers for cross-origin modules
     • Cache behavior (304 vs 200 status)

🔍 What to Notice:
  • ES modules load in parallel (multiple requests at once)
  • Each import creates a separate network request
  • Browser automatically handles dependency resolution
  • Modules are cached after first load

⚡ Performance Insights:
  • Module loading happens during HTML parsing
  • No JavaScript execution blocking
  • HTTP/2 multiplexing helps with parallel requests
  • Tree shaking possible with proper bundlers

🎯 Console Commands to Try:
  performance.getEntriesByType('resource')
  performance.getEntriesByType('navigation')
  console.log(import.meta.url)
  
🌐 Module-specific in Network tab:
  • Filter by "JS" to see only JavaScript files
  • Check "Initiator" column for import chains
  • "Size" column shows actual vs compressed size`;
        };
        
        // Clear functions
        window.clearBrowserLog = () => {
            document.getElementById('browser-timeline').innerHTML = '🌐 Browser ES Module Loading Timeline:\n\nWaiting for simulation...';
        };
        
        window.clearNodeLog = () => {
            document.getElementById('nodejs-timeline').innerHTML = '🟢 Node.js CommonJS Loading Timeline:\n\nWaiting for simulation...';
        };
        
        window.clearComparison = () => {
            document.getElementById('browser-comparison').innerHTML = 'Click "Run Comparison" to see both loading patterns simultaneously!';
            document.getElementById('nodejs-comparison').innerHTML = 'Click "Run Comparison" to see both loading patterns simultaneously!';
        };
        
        console.log('⚡ Loading demo initialized with real ES modules!');
        console.log('📦 Imported functions working:', { 
            add: add(2, 3), 
            multiply: multiply(4, 5),
            environment: config.environment 
        });
    </script>
</body>
</html>